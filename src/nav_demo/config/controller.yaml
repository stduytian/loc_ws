# # 控制器服务器（使用 Regulated Pure Pursuit，输出 /cmd_vel）
# controller_server:
#   ros__parameters:
#     use_sim_time: False
#     controller_frequency: 20.0
#     min_x_velocity_threshold: 0.001
#     min_y_velocity_threshold: 0.5
#     min_theta_velocity_threshold: 0.001
#     odom_topic: /odom
#     cmd_vel_topic: /cmd_vel
#     controller_plugins: ["FollowPath"]

#     # 添加进度检查器和目标检查器（必需）
#     progress_checker_plugins: ["progress_checker"]
#     goal_checker_plugins: ["goal_checker"]

#     # 进度检查器配置
#     progress_checker:
#       plugin: "nav2_controller::SimpleProgressChecker"
#       required_movement_radius: 0.3
#       movement_time_allowance: 10.0

#     # 目标检查器配置
#     goal_checker:
#       plugin: "nav2_controller::SimpleGoalChecker"
#       xy_goal_tolerance: 0.25
#       yaw_goal_tolerance: 0.25
#       stateful: True

#     # FollowPath 插件配置（移除不兼容参数，如 max_linear_accel）
#     FollowPath:
#       # 一种基于纯追踪的路径跟随算法
#       plugin: "nav2_regulated_pure_pursuit_controller::RegulatedPurePursuitController"
#       desired_linear_vel: 0.3
#       lookahead_dist: 0.8
#       min_lookahead_dist: 0.3
#       max_lookahead_dist: 1.5
#       lookahead_time: 1.5
#       rotate_to_heading_angular_vel: 0.3
#       transform_tolerance: 0.2
#       use_velocity_scaled_lookahead_dist: True
#       # 添加以下 RPP 特定参数（可选，根据需要调整）
#       min_approach_linear_velocity: 0.05
#       approach_velocity_scaling_dist: 0.6
#       use_collision_detection: True
#       use_regulated_linear_velocity_scaling: True
#       regulated_linear_scaling_min_radius: 0.6
#       regulated_linear_scaling_min_speed: 0.2
#       allow_reversing: True
#       # 移除：max_linear_accel, max_linear_decel（不适用于 RPP）
#       # 保留 costmap_cost_threshold，如果需要碰撞检测阈值
#       costmap_cost_threshold: 200

# controller_server:
#   ros__parameters:
#     use_sim_time: False
#     controller_frequency: 20.0
#     min_x_velocity_threshold: 0.001
#     min_y_velocity_threshold: 0.5
#     min_theta_velocity_threshold: 0.001
#     failure_tolerance: 0.3
#     progress_checker_plugins: ["progress_checker"]
#     goal_checker_plugins: ["general_goal_checker"]
#     controller_plugins: ["FollowPath"]

#     # 进度和目标检查器（保持一致）
#     progress_checker:
#       plugin: "nav2_controller::SimpleProgressChecker"
#       required_movement_radius: 0.5
#       movement_time_allowance: 15.0
#     general_goal_checker:
#       stateful: True
#       plugin: "nav2_controller::SimpleGoalChecker"
#       xy_goal_tolerance: 0.25
#       yaw_goal_tolerance: 0.1

#     # TEB 插件配置
#     FollowPath:
#       plugin: "nav2_teb_local_planner::TebLocalPlanner"  # Nav2 专用 TEB 插件
#       debug_trajectory_details: true  # 启用轨迹调试

#       # 机器人足迹
#       footprint_model:
#         type: "polygon"  # 或 "circle" 以简化
#         vertices: "[[-0.2, -0.2], [0.2, -0.2], [0.2, 0.2], [-0.2, 0.2]]"  # 示例矩形足迹

#       # 速度与动力学（匹配你的机器人）
#       min_vel_x: 0.0
#       max_vel_x: 0.3
#       max_vel_theta: 1.0
#       acc_lim_x: 2.5
#       decel_lim_x: -2.5
#       acc_lim_theta: 3.2
#       decel_lim_theta: -3.2
#       min_turning_radius: 0.0  # 允许原地旋转

#       # 优化与采样
#       dt_ref: 0.3
#       dt_hysteresis: 0.1
#       min_samples: 3
#       max_samples: 500
#       no_inner_iterations: 5
#       no_outer_iterations: 4
#       allow_init_with_backwards_motion: true

#       # 代价地图与避障
#       costmap_converter_plugin: "costmap_converter::CostmapToPolygonsDBSMCC"  # 启用时设为 "costmap_converter::CostmapToPolygonsDBSMCCH"
#       costmap_converter_rate: 5.0
#       inflation_dist: 0.6
#       weight_obstacle: 50.0  # 避障权重
#       weight_inflation: 0.1
#       exact_arc_length: false

#       # 全局路径处理
#       global_plan_overwrite_orientation: true
#       max_global_plan_lookahead_dist: 3.0
#       global_plan_viapoint_sep: -0.1  # 禁用 via-point 采样

#       # 优化权重（核心：平衡平滑与避障）
#       weight_kinematics_nh: 1000  # 非全息平滑
#       weight_kinematics_forward_drive: 1.0  # 鼓励前进
#       weight_optimal_time: 1.0  # 时间最优
#       weight_shortest_path: 0.0  # 禁用路径长度（优先时间）
#       weight_viapoint: 1.0

#       # 同伦类规划（HCP）
#       max_number_classes: 4
#       enable_multithreading: true
#       simple_exploration: false  # 用 full exploration 探索备选路径

#       # 其他
#       transform_tolerance: 0.2
#       stateful: true
#       feasibility_check_no_poses: 5  # 后优化碰撞检查

# controller_server:
#   ros__parameters:
#     use_sim_time: False
#     controller_frequency: 20.0
#     min_x_velocity_threshold: 0.001
#     min_y_velocity_threshold: 0.5
#     min_theta_velocity_threshold: 0.001
#     failure_tolerance: 0.3
#     progress_checker_plugins: ["progress_checker"]
#     goal_checker_plugins: ["general_goal_checker"]
#     controller_plugins: ["FollowPath"]

#     # 进度和目标检查器（与之前类似）
#     progress_checker:
#       plugin: "nav2_controller::SimpleProgressChecker"
#       required_movement_radius: 0.5
#       movement_time_allowance: 15.0
#     general_goal_checker:
#       stateful: True
#       plugin: "nav2_controller::SimpleGoalChecker"
#       xy_goal_tolerance: 0.25
#       yaw_goal_tolerance: 0.1

#     # MPPI 插件配置
#     FollowPath:
#       plugin: "nav2_mppi_controller::MPPIController"
#       debug_trajectory_details: true  # 启用轨迹调试输出

#       # 速度限制
#       min_vel_x: 0.0
#       max_vel_x: 0.3
#       max_vel_theta: 1.0
#       min_speed_xy: 0.0
#       max_speed_xy: 0.3
#       min_speed_theta: 0.0

#       # 采样和优化参数（核心：控制轨迹生成多样性）
#       trajectory_samples: 1000  # 采样轨迹数（默认 1000，高值更优化但计算密集）
#       batch_size: 1000  # 批处理大小
#       sample_batch_size: 1  # 每个批次的采样数
#       num_iterations: 5  # 优化迭代次数

#       # 动力学约束
#       acc_lim_x: 2.5
#       decel_lim_x: -2.5
#       acc_lim_theta: 3.2
#       decel_lim_theta: -3.2
#       vx_std_dev: 0.2  # X 速度噪声标准差
#       vy_std_dev: 0.2  # Y 速度噪声标准差
#       vtheta_std_dev: 0.4  # 角速度噪声标准差
#       lateral_acceleration_std_dev: 0.5  # 横向加速度噪声

#       # 代价函数权重（类似于 critics，用于评分轨迹）
#       path_following_weight: 10.0  # 路径跟随权重
#       goal_following_weight: 5.0   # 目标跟随权重
#       obstacle_weight: 100.0       # 避障权重（高值优先避开）
#       velocity_weight: 1.0         # 速度平滑权重

#       # 其他
#       transform_tolerance: 0.2
#       stateful: true
#       costmap_weight: 1.0  # 代价地图权重
